# NXLink WebTools

一个功能强大的Web工具平台，提供表单集成、AI对话管理等核心功能。

## 📁 项目结构

```
nxlinkWebTools/
├── config/                 # 配置文件目录
│   ├── form-templates.config.ts    # 表单模板配置 ⭐
│   ├── project.config.ts           # 项目基础配置
│   └── README.md                   # 配置说明
├── tests/                  # 测试脚本目录
│   ├── api/                        # API功能测试
│   ├── docker/                     # Docker测试
│   ├── integration/                # 集成测试
│   └── README.md                   # 测试说明
├── docs/                   # 文档目录
│   ├── new-webhook-api-guide.md    # 新API使用指南 ⭐
│   └── ...                        # 其他文档
├── src/                    # 前端源码
├── server/                 # 后端源码
│   ├── src/routes/                 # API路由
│   └── ...
└── README.md               # 项目说明
```

## 功能

1. 保存用户通用参数（nxCloudUserID, sourceTenantID, targetTenantID, authorization）到本地存储
2. 从源租户查询标签分组并展示
3. 支持多选标签分组
4. 将选中的标签分组及其标签复制到目标租户
5. 支持Excel/CSV批量导入标签

## 使用流程

1. 在"通用参数设置"中填写并保存必要的参数
2. 在"标签分组迁移"部分，查看源租户的标签分组列表
3. 选择需要迁移的标签分组
4. 点击"开始迁移"按钮
5. 等待迁移完成，查看结果

## 账单管理系统

账单管理系统是一个功能完善的AI账单查询和分析工具，提供以下核心功能：

### 主要功能

1. **账单查询与筛选**
   - 支持按公司、团队、时间范围查询账单
   - 高级筛选功能：客户名称、租户名称、用户号码、通话时长等多维度筛选
   - 智能前端分页和后端分页相结合

2. **数据展示**
   - 20列详细账单信息展示
   - 支持用户号码脱敏显示（可切换）
   - 响应式表格设计，支持横向滚动

3. **汇总统计** 🆕
   - **财务概览**：总记录数、线路消费、AI消费、AI成本、利润分析
   - **成本分析**：ASR成本、TTS成本、LLM成本详细统计
   - **效率指标**：总通话时长、平均通话时长、平均每通成本
   - **计算公式提示**：每个统计项都有详细的计算公式说明
   - **公司标识**：显示当前查询的公司名称
   - **时间范围显示**：显示查询的具体时间范围

4. **Excel导出** 🆕
   - **完整数据导出**：支持导出最多10000条记录
   - **列格式优化**：币种信息置于表头，数据行为纯数字便于计算
   - **脱敏支持**：可选择导出脱敏或完整数据
   - **智能文件命名**：包含公司名和时间戳的文件名
   - **20列完整导出**：与页面显示列完全一致

5. **分页优化** 🆕
   - **默认1000条**：默认每页显示1000条数据
   - **灵活选择**：支持10/20/50/100/500/1000条每页
   - **快速浏览**：支持页面跳转和页面大小选择

### 数据字段说明

账单系统包含以下20个主要字段：

| 字段名 | 说明 | 备注 |
|--------|------|------|
| 消费时间 | 账单消费的具体时间 | - |
| Agent流程名称 | AI流程的名称 | - |
| 用户号码 | 被叫用户号码 | 支持脱敏显示 |
| 线路号码 | 主叫线路号码 | - |
| 呼叫方向 | 呼出/呼入 | - |
| 线路消费(USD) | 线路相关费用 | 8位小数精度 |
| AI消费(USD) | AI服务费用 | 8位小数精度 |
| AI总成本(USD) | AI服务总成本 | 8位小数精度 |
| 线路消费(币种) | 客户原始币种的线路费用 | 列标题动态显示实际币种，如：线路消费(IDR) |
| AI消费(币种) | 客户原始币种的AI费用 | 列标题动态显示实际币种，如：AI消费(CNY) |
| 通话时长(秒) | 实际通话时间 | - |
| 线路计费时长(秒) | 线路计费时间 | - |
| AI计费时长(秒) | AI服务计费时间 | - |
| ASR成本(USD) | 语音识别成本 | 8位小数精度 |
| TTS成本(USD) | 语音合成成本 | 8位小数精度 |
| LLM成本(USD) | 大语言模型成本 | 8位小数精度 |
| 线路计费规则 | 线路计费方式 | - |
| AI计费规则 | AI计费方式 | - |
| 客户名称 | 客户公司名称 | - |
| 团队名称 | 租户团队名称 | - |

### 使用方法

1. **设置API令牌**：在API令牌管理区域配置认证信息
2. **选择查询条件**：选择公司、团队和时间范围
3. **执行查询**：点击查询按钮获取账单数据
4. **高级筛选**：使用高级筛选功能进一步筛选数据
5. **查看统计**：查看汇总统计信息了解财务概况
6. **导出数据**：选择脱敏模式并导出Excel文件

### 特色功能

- **智能脱敏**：用户号码支持脱敏显示，保护隐私
- **实时统计**：汇总数据随筛选条件实时更新
- **便于计算**：Excel导出格式优化，便于进一步数据分析
- **多维筛选**：支持20个字段的组合筛选
- **大数据支持**：单次最多处理10000条记录

## 最新功能更新

### v2.1.0 (2024年最新更新)

#### 🆕 账单汇总统计功能
- **新增财务概览统计**：实时显示总记录数、线路消费、AI消费、AI成本、利润等关键指标
- **成本分析详情**：ASR成本、TTS成本、LLM成本的详细统计和分析
- **效率指标统计**：总通话时长、平均通话时长、平均每通成本
- **交互式提示**：每个统计项都有详细的计算公式悬浮提示
- **公司标识显示**：在统计区域显示当前查询的公司名称
- **时间范围显示**：智能显示查询的时间范围，便于截图和记录

#### 🔧 Excel导出功能优化
- **列格式优化**：将币种信息(USD)移至表头，数据行只包含纯数字，便于Excel计算
- **完全一致性**：导出的20列与页面显示完全一致，无多余或缺失字段
- **智能文件命名**：自动生成包含公司名、时间范围和脱敏状态的文件名
- **高精度支持**：财务数据保持8位小数精度

#### ⚡ 分页性能优化
- **默认优化**：默认每页显示1000条数据，减少翻页操作
- **选项扩展**：新增500和1000条的分页选项
- **大数据友好**：优化大数据量的加载和显示性能

#### 🎯 用户体验提升
- **响应式统计卡片**：汇总统计区域支持不同屏幕尺寸自适应
- **颜色编码**：不同类型的统计数据使用不同颜色，便于快速识别
- **利润分析**：自动计算并高亮显示盈利/亏损状态

## 话术测试系统

话术测试系统是一个用于管理和测试客服话术的工具，具有以下功能：

### 主要功能

1. **测试任务管理**
   - 创建、编辑和删除测试任务
   - 每个任务可包含多个测试案例

2. **测试案例管理**
   - 创建、编辑和删除测试案例
   - 为每个案例添加对话行

3. **对话测试**
   - 支持坐席和客户角色的对话
   - 对每行对话进行预期符合度评估
   - 支持音频播放功能

4. **TTS语音生成**
   - 支持火山引擎和11labs两种TTS服务
   - 为每行对话生成音频
   - 可配置TTS服务的API密钥

5. **导入导出功能**
   - 支持Excel格式导入导出话术测试脚本
   - 每个工作表对应一个测试案例

### 使用方法

1. 点击"新增测试任务"按钮创建任务
2. 在任务中添加测试案例
3. 在测试案例中添加对话行
4. 为对话生成TTS音频并播放
5. 评估对话是否符合预期
6. 需要时可导出测试任务为Excel文件

### TTS服务配置

系统支持两种TTS服务：

1. **火山引擎**：需要配置API Key和API Secret
2. **11labs**：需要配置API Key

可以在设置面板中配置这些API密钥。 

## 配置文件说明

项目包含以下主要配置文件：

1. **vite.config.ts**
   - 位置：项目根目录
   - 用途：Vite构建工具配置，包括开发服务器、代理和构建选项
   - 关键配置：
     - `server.port`: 开发服务器端口（默认3000）
     - `server.proxy`: API代理配置，解决跨域问题

2. **server.js**
   - 位置：项目根目录
   - 用途：生产环境Express服务器，提供静态文件和API代理
   - 关键配置：
     - `PORT`: 服务器端口（默认4000）
     - API代理路径：`/api` -> `https://nxlink.nxcloud.com`

3. **src/services/api.ts**
   - 位置：src/services目录
   - 用途：API服务配置，包括Axios实例和API请求函数
   - 关键配置：
     - `baseURL`: API请求基础路径
     - 请求拦截器：添加认证头和系统ID

4. **package.json**
   - 位置：项目根目录
   - 用途：项目依赖和脚本命令
   - 关键脚本：
     - `npm start`: 启动开发服务器
     - `npm run build`: 构建生产版本
     - `npm run prod`: 启动生产服务器

## 开发和构建

### 安装依赖

```bash
npm install
# 安装生产服务器所需依赖
npm install cors express http-proxy-middleware --save
```

### 启动开发服务器

```bash
npm start
```

### 构建生产版本

```bash
npm run build
```

### 启动生产服务器

```bash
npm run prod
```
应用将在 http://localhost:4000 上运行

## 部署说明

### 部署到其他服务器

1. 构建项目并复制以下文件到服务器：
   - `dist/` 目录（构建后的静态文件）
   - `server.js`（生产服务器配置）
   - `package.json`（依赖信息）

2. 在服务器上安装依赖：
   ```bash
   npm install --production
   ```

3. 启动服务器：
   ```bash
   node server.js
   ```
   或使用PM2等进程管理器：
   ```bash
   pm2 start server.js --name tag-migration-tool
   ```

### 修改服务器端口

编辑 `server.js` 文件中的以下行：
```javascript
const PORT = process.env.PORT || 4000;
```

### 修改API地址

如需指向其他API服务器，修改 `server.js` 中的代理配置：
```javascript
app.use('/api', createProxyMiddleware({
  target: 'https://your-api-server.com',
  // ...其他配置
}));
``` 